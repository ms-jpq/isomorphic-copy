#!/usr/bin/env python3

from os import environ
from os.path import dirname, realpath
from shutil import which
from socket import socket, AF_UNIX, SOCK_STREAM
from subprocess import run
from sys import stderr, stdin


__dir__ = dirname(realpath(__file__))
__socket_path__ = ""


def fake_path() -> None:
  environ["PATH"] = ":".join((path
                              for path in environ["PATH"].split(":")
                              if path != __dir__))


def tmux_cp(data: bytes) -> None:
  if environ.get("TMUX", None):
    run(["tmux", "load-buffer", "-"], input=data)


def clippy(data: bytes) -> None:
  tmux_cp(data)

  if which("pbcopy"):
    run(["pbcopy"], input=data)
  else:
    print("⚠️ No clipboard integration ⚠️", file=stderr)
    exit(1)


def remote_copy(path: str, data: str) -> None:
  with socket(AF_UNIX, SOCK_STREAM) as sock:
    sock.connect(path)
    sock.sendall(data)
    sock.sendall(b'\0\n')


def cp() -> None:
  data: bytes = stdin.read().strip("\n").encode()
  if environ.get("SSH_TTY") is not None:
    tmux_cp(data)
    remote_copy(__socket_path__, data)
  else:
    clippy(data)


def main() -> None:
  fake_path()
  try:
    cp()
  except KeyboardInterrupt:
    pass
  except Exception as e:
    print(e, file=stderr)
    print("\a")
    exit(1)


main()

