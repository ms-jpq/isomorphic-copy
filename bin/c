#!/usr/bin/env python3

from os import environ, getcwd, unlink
from os.path import basename, dirname, join, realpath, relpath
from shutil import which
from socket import AF_UNIX, SOCK_STREAM, socket
from socketserver import BaseRequestHandler, UnixStreamServer
from subprocess import PIPE, Popen, run
from sys import argv, stderr, stdin, stdout
from time import sleep
from typing import Iterable, List

__dir__ = dirname(realpath(__file__))
__socket_path__ = ""


def path_mask() -> None:
  paths: Iterable[str] = (path
                          for path in environ["PATH"].split(":")
                          if path != __dir__)
  environ["PATH"] = ":".join(paths)


def tmux_cp(data: bytes) -> None:
  if environ.get("TMUX"):
    run(["tmux", "load-buffer", "-"], input=data)


def copy(data: bytes) -> None:
  tmux_cp(data)
  if which("pbcopy"):
    run(["pbcopy"], input=data)
  else:
    print("⚠️ No clipboard integration ⚠️", file=stderr)
    exit(1)


def paste() -> None:
  if which("pbpaste"):
    run(["pbpaste"])
  elif environ.get("TMUX"):
    run(["tmux", "save-buffer", "-"])
  else:
    print("⚠️ No clipboard integration ⚠️", file=stderr)
    exit(1)


def csshd() -> str:
  home = environ["HOME"]
  canonical = join(__dir__, "csshd")

  if canonical.startswith(home):
    p = join(getcwd(), canonical)
    prog = relpath(p, home)
    return f"$HOME/{prog}"
  else:
    return canonical


def local_daemon(args: List[str]) -> None:
  prog = csshd()
  process = Popen(
      ["ssh", *args, f"{prog}"],
      stdout=PIPE,
      stderr=PIPE)

  buf = bytearray()
  while True:
    code = process.poll()
    if code:
      print(f"ssh exited - {code}", file=stderr)
      print(process.stderr.read().decode(), file=stderr)
      print("\a")
      return

    line: bytes = process.stdout.readline()
    for b in line:
      if b == 0:
        clippy(buf)
        buf.clear()
        break
      else:
        buf.append(b)


def clean_socket(path: str) -> None:
  try:
    unlink(path)
  except IOError:
    pass


def remote_daemon(path: str) -> None:
  class Handler(BaseRequestHandler):
    def handle(self) -> None:
      with self.request.makefile() as fd:
        data: str = fd.read()
        stdout.write(data)
        stdout.flush()

  clean_socket(path)
  with UnixStreamServer(path, Handler) as srv:
    srv.serve_forever()


def remote_copy(path: str, data: str) -> None:
  with socket(AF_UNIX, SOCK_STREAM) as sock:
    sock.connect(path)
    sock.sendall(data)
    sock.sendall(b'\0\n')


def main() -> None:
  name = basename(argv[0])

  runtime_dir = environ.get(
      "XDG_RUNTIME_DIR", join(environ["HOME"], ".ssh"))
  socket_path = join(runtime_dir, "copy_socket")

  if name == "cssh":
    while True:
      local_daemon(argv[1:])
      sleep(1)
  if name == "csshd":
    remote_daemon(socket_path)


try:
  main()
except KeyboardInterrupt:
  pass
